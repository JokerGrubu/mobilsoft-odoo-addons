<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Partner Form View Extension — Nilvera ile ortak alanlar (l10n_tr_nilvera_customer_status, l10n_tr_nilvera_customer_alias_id) -->
    <record id="view_partner_form_qnb" model="ir.ui.view">
        <field name="name">res.partner.form.qnb</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">
            <!-- e-Fatura Bilgileri Tab -->
            <xpath expr="//page[@name='sales_purchases']" position="after">
                <page string="e-Fatura" name="efatura_info">
                    <group>
                        <group string="e-Fatura Durumu (Nilvera / QNB ortak)">
                            <field name="l10n_tr_nilvera_customer_status" readonly="1"/>
                            <field name="l10n_tr_nilvera_customer_alias_id" readonly="1" 
                                   invisible="l10n_tr_nilvera_customer_status != 'einvoice'"/>
                            <field name="qnb_last_check_date" readonly="1"/>
                        </group>
                        <group string="2025 Bakiye (31.12.2025)">
                            <field name="balance_2025_receivable" readonly="1"/>
                            <field name="balance_2025_payable" readonly="1"/>
                            <field name="balance_2025_net" readonly="1"/>
                        </group>
                        <group string="İşlemler">
                            <button name="action_fetch_from_nilvera" 
                                    string="Nilvera'dan Sorgula ve Doldur" 
                                    type="object" 
                                    class="btn-primary"
                                    icon="fa-search"
                                    invisible="not vat"/>
                            <button name="action_check_efatura_status" 
                                    string="e-Fatura Durumunu Kontrol Et" 
                                    type="object" 
                                    class="btn-secondary"
                                    icon="fa-check"
                                    invisible="not vat"/>
                            <div class="text-muted" invisible="vat">
                                <i class="fa fa-info-circle"/> Tüm bilgiler Nilvera'dan gelir. VKN/TCKN girin ve "Nilvera'dan Sorgula ve Doldur"a tıklayın.
                            </div>
                        </group>
                    </group>
                    <group string="Bilgi" invisible="not qnb_last_check_date">
                        <div class="alert alert-info" role="alert">
                            <i class="fa fa-info-circle"/>
                            <span invisible="l10n_tr_nilvera_customer_status != 'einvoice'">
                                Bu firma e-Fatura mükellefi olarak kayıtlıdır. 
                                Kesilen faturalar <strong>e-Fatura</strong> olarak gönderilecektir.
                            </span>
                            <span invisible="l10n_tr_nilvera_customer_status == 'einvoice'">
                                Bu firma e-Fatura mükellefi olarak kayıtlı değildir. 
                                Kesilen faturalar <strong>e-Arşiv</strong> olarak gönderilecektir.
                            </span>
                        </div>
                    </group>
                </page>
            </xpath>

            <!-- VKN alanının yanına e-Fatura badge -->
            <xpath expr="//field[@name='vat']" position="after">
                <span class="badge text-bg-success ms-2" 
                      invisible="l10n_tr_nilvera_customer_status != 'einvoice'">
                    <i class="fa fa-check"/> e-Fatura Mükellefi
                </span>
                <field name="l10n_tr_nilvera_customer_status" invisible="1"/>
            </xpath>
        </field>
    </record>

    <!-- Partner List View Extension -->
    <record id="view_partner_tree_qnb" model="ir.ui.view">
        <field name="name">res.partner.tree.qnb</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_tree"/>
        <field name="arch" type="xml">
            <field name="email" position="after">
                <field name="l10n_tr_nilvera_customer_status" string="e-Fatura" optional="show"/>
            </field>
        </field>
    </record>

    <!-- Partner Search View Extension -->
    <record id="view_partner_search_qnb" model="ir.ui.view">
        <field name="name">res.partner.search.qnb</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_res_partner_filter"/>
        <field name="arch" type="xml">
            <filter name="inactive" position="after">
                <separator/>
                <filter string="e-Fatura Mükellefi" name="efatura_registered" 
                        domain="[('l10n_tr_nilvera_customer_status', '=', 'einvoice')]"/>
                <filter string="e-Fatura Dışı" name="efatura_not_registered" 
                        domain="[('l10n_tr_nilvera_customer_status', '!=', 'einvoice')]"/>
            </filter>
        </field>
    </record>
</odoo>
