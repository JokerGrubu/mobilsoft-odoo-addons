<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="res_config_settings_view_form_qnb" model="ir.ui.view">
        <field name="name">res.config.settings.view.form.qnb</field>
        <field name="model">res.config.settings</field>
        <field name="inherit_id" ref="base.res_config_settings_view_form"/>
        <field name="priority">50</field>
        <field name="arch" type="xml">
            <xpath expr="//form" position="inside">
                <app data-string="QNB e-Solutions" string="QNB e-Solutions" name="mobilsoft_qnb_efatura" groups="account.group_account_manager">
                    <block title="API Bağlantı Ayarları" name="qnb_connection_settings">
                        <setting id="qnb_enabled" string="QNB e-Solutions Entegrasyonu" 
                                 help="QNB e-Solutions e-Fatura/e-Arşiv/e-İrsaliye entegrasyonunu etkinleştirin">
                            <field name="qnb_enabled"/>
                        </setting>
                        <setting id="qnb_environment" string="Ortam" invisible="not qnb_enabled"
                                 help="Test: connectortest.efinans.com.tr / Canlı: connector.efinans.com.tr">
                            <field name="qnb_environment" widget="radio"/>
                        </setting>
                        <setting id="qnb_credentials" string="API Bilgileri" invisible="not qnb_enabled">
                            <div class="row mt16">
                                <label for="qnb_username" string="Kullanıcı Adı (VKN)" class="col-lg-3 o_light_label"/>
                                <field name="qnb_username" class="col-lg-4" placeholder="1234567890"/>
                            </div>
                            <div class="row mt16">
                                <label for="qnb_password" string="Şifre" class="col-lg-3 o_light_label"/>
                                <field name="qnb_password" class="col-lg-4" password="True"/>
                            </div>
                            <div class="row mt16">
                                <label for="qnb_wsdl_url" string="Özel WSDL URL (Opsiyonel)" class="col-lg-3 o_light_label"/>
                                <field name="qnb_wsdl_url" class="col-lg-6" 
                                       placeholder="https://erpefaturatest1.qnbesolutions.com.tr/efatura/ws/connectorService?wsdl"/>
                            </div>
                            <div class="mt16">
                                <button name="action_test_qnb_connection" type="object" 
                                        string="Bağlantıyı Test Et" class="btn-primary" icon="fa-plug"/>
                            </div>
                        </setting>
                    </block>

                    <block title="e-Fatura / e-Arşiv" name="qnb_edi_settings" invisible="not qnb_enabled">
                        <setting id="qnb_efatura_enabled" string="e-Fatura Aktif">
                            <field name="qnb_efatura_enabled"/>
                        </setting>
                        <setting id="qnb_efatura_scenario" string="Fatura Senaryosu" invisible="not qnb_efatura_enabled">
                            <field name="qnb_efatura_scenario" widget="radio"/>
                        </setting>
                        <setting id="qnb_earsiv_enabled" string="e-Arşiv Aktif">
                            <field name="qnb_earsiv_enabled"/>
                        </setting>
                        <setting id="qnb_earsiv_send_type" string="Gönderim Tipi" invisible="not qnb_earsiv_enabled">
                            <field name="qnb_earsiv_send_type" widget="radio"/>
                        </setting>
                    </block>

                    <block title="Otomatik İşlemler" name="qnb_auto_settings" invisible="not qnb_enabled">
                        <setting id="qnb_auto_fetch" string="Gelen Belgeleri Otomatik Al"
                                 help="Gelen e-Faturaları otomatik olarak indir">
                            <field name="qnb_auto_fetch_incoming"/>
                        </setting>
                        <setting id="qnb_auto_fetch_outgoing" string="Giden Belgeleri Otomatik Al"
                                 help="Giden e-Fatura/e-Arşiv faturalarını Odoo'ya al ve PDF'ini indir">
                            <field name="qnb_auto_fetch_outgoing"/>
                        </setting>
                        <setting id="qnb_auto_check" string="Durumu Otomatik Kontrol Et"
                                 help="Gönderilen belgelerin durumunu periyodik olarak kontrol et">
                            <field name="qnb_auto_check_status"/>
                        </setting>
                    </block>

                    <block title="Veri düzeltme" name="qnb_data_fix">
                        <div class="mt16">
                            <button name="action_qnb_fill_partner_vat_from_list" type="object"
                                    string="VAT Eksik Carileri QNB Listesinden Doldur"
                                    class="btn-secondary" icon="fa-id-card"/>
                            <span class="text-muted ms-2">Faturada geçen ama VKN boş carilerin VKN'sini QNB gelen belge listesinden alır.</span>
                        </div>
                        <div class="mt16">
                            <button name="action_qnb_update_partners_from_mukellef" type="object"
                                    string="Carileri QNB Mükellef Bilgisiyle Güncelle"
                                    class="btn-primary" icon="fa-refresh"/>
                            <span class="text-muted ms-2">VKN'ı olan tüm carilerde GİB mükellef sorgusu (kayıtlı kullanıcı) yapılır; ünvan ve e-Fatura posta kutusu (alias) güncellenir.</span>
                        </div>
                        <div class="mt16">
                            <button name="action_qnb_update_partners_nilvera_only" type="object"
                                    string="Carileri Sadece Nilvera ile Güncelle (Hızlı)"
                                    class="btn-secondary" icon="fa-bolt"/>
                            <span class="text-muted ms-2">VKN'lı tüm carileri sadece Nilvera + QNB XML ile günceller; GİB çağrısı yok, daha hızlı.</span>
                        </div>
                    </block>

                    <block title="Kullanım" name="qnb_usage" invisible="not qnb_enabled">
                        <div class="text-muted">
                            Giden faturalar standart “Gönder” ekranından iletilir. Gelen faturalar otomatik cron ile gelir.
                            QNB belge ekranı kaldırılmıştır.
                        </div>
                    </block>

                </app>
            </xpath>
        </field>
    </record>

    <!-- Config Settings Action -->
    <record id="action_qnb_config_settings" model="ir.actions.act_window">
        <field name="name">QNB e-Solutions Ayarları</field>
        <field name="res_model">res.config.settings</field>
        <field name="view_mode">form</field>
        <field name="target">current</field>
        <field name="context">{'module': 'mobilsoft_qnb_efatura'}</field>
    </record>
</odoo>
